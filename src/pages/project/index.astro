---
import { getCollection } from "astro:content";
import Grid from "@/components/bento/Grid.astro";
import GridItem from "@/components/bento/Item.astro";
import Header from "@/components/util/Header.astro";
import Layout from "@/layouts/Layout.astro";
import { ArrowRightIcon } from "astro-feather";

const projects = await getCollection("projects");
const sortedProjects = projects.sort((a, b) => b.data.year - a.data.year);

// Get unique categories and map to display labels
const categoryLabels: Record<string, string> = {
  featured: "Featured",
  "open-source": "Open Source",
  "client-work": "Client Work",
  "side-project": "Side Project"
};

const categories = [...new Set(projects.map((p) => p.data.category))];
---

<script is:inline>
  function initProjectFilters() {
    const projectItems = document.querySelectorAll(".project-item");
    const filterButtons = document.querySelectorAll(".filter-btn");
    const sortToggle = document.getElementById("sort-toggle");
    const sortText = document.getElementById("sort-text");
    const sortIcon = document.getElementById("sort-icon");
    const projectsContainer = document.getElementById("projects-container");
    
    if (!projectsContainer || projectItems.length === 0) return;

    const urlParams = new URLSearchParams(window.location.search);
    let currentCategory = urlParams.get("category") || "all";
    let currentSort = urlParams.get("sort") || "newest";

    function updateSortIcon() {
      const currentIcon = document.getElementById("sort-icon");
      if (currentIcon) {
        currentIcon.style.transform = currentSort === "newest" ? "rotate(0deg)" : "rotate(180deg)";
      }
    }

    function filterProjects() {
      projectItems.forEach((item) => {
        const itemCategory = item.getAttribute("data-category");
        if (currentCategory === "all" || itemCategory === currentCategory) {
          item.classList.remove("hidden");
        } else {
          item.classList.add("hidden");
        }
      });
    }

    function sortProjects() {
      const items = Array.from(projectItems).filter(item => !item.classList.contains("hidden"));
      items.sort((a, b) => {
        const yearA = parseInt(a.getAttribute("data-year") || "0");
        const yearB = parseInt(b.getAttribute("data-year") || "0");
        return currentSort === "newest" ? yearB - yearA : yearA - yearB;
      });

      items.forEach((item) => {
        projectsContainer?.appendChild(item);
      });
    }

    function updateURL() {
      const url = new URL(window.location.href);
      if (currentCategory === "all") {
        url.searchParams.delete("category");
      } else {
        url.searchParams.set("category", currentCategory);
      }
      if (currentSort === "newest") {
        url.searchParams.delete("sort");
      } else {
        url.searchParams.set("sort", currentSort);
      }
      window.history.replaceState({}, "", url);
    }

    function applyFiltersAndSort() {
      filterProjects();
      sortProjects();
      updateSortIcon();
      updateURL();
    }

    function setInitialActiveState() {
      filterButtons.forEach((btn) => {
        const btnCategory = btn.getAttribute("data-category");
        if (btnCategory === currentCategory) {
          btn.classList.add("active");
        } else {
          btn.classList.remove("active");
        }
      });
      if (sortText) {
        sortText.textContent = currentSort === "newest" ? "Newest First" : "Oldest First";
      }
    }

    // Remove existing listeners to prevent duplicates
    filterButtons.forEach((button) => {
      const newButton = button.cloneNode(true);
      button.parentNode?.replaceChild(newButton, button);
    });
    
    // Re-query buttons after cloning
    const freshButtons = document.querySelectorAll(".filter-btn");
    freshButtons.forEach((button) => {
      button.addEventListener("click", () => {
        freshButtons.forEach((btn) => btn.classList.remove("active"));
        button.classList.add("active");
        currentCategory = button.getAttribute("data-category") || "all";
        applyFiltersAndSort();
      });
    });

    const newSortToggle = sortToggle?.cloneNode(true);
    if (sortToggle && newSortToggle) {
      sortToggle.parentNode?.replaceChild(newSortToggle, sortToggle);
      newSortToggle.addEventListener("click", () => {
        currentSort = currentSort === "newest" ? "oldest" : "newest";
        const newSortText = document.getElementById("sort-text");
        if (newSortText) {
          newSortText.textContent = currentSort === "newest" ? "Newest First" : "Oldest First";
        }
        applyFiltersAndSort();
      });
    }

    setInitialActiveState();
    applyFiltersAndSort();
  }

  // Run on initial load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initProjectFilters);
  } else {
    initProjectFilters();
  }
  
  // Run on Astro page transitions
  document.addEventListener("astro:page-load", initProjectFilters);
</script>

<style>
  .badge {
    @apply text-xs px-2 py-1 bg-secondary-bg text-secondary-text rounded;
  }
  .filter-btn {
    @apply px-3 py-1 rounded-md text-sm transition-colors;
  }
  .filter-btn.active {
    @apply bg-primary-accent text-white;
  }
  .filter-btn:not(.active) {
    @apply bg-secondary-bg text-secondary-text hover:bg-tertiary-bg;
  }
  .sort-toggle {
    @apply flex items-center gap-2 px-3 py-1 rounded-md text-sm bg-secondary-bg text-secondary-text hover:bg-tertiary-bg transition-colors;
  }
  .hidden {
    display: none;
  }
</style>

<Layout title="Pak Maneth | Projects" desc="A collection of things I've built.">
  <Grid className="auto-rows-auto">
    <Header heading="Projects" subtitle="A collection of things I've built." />
  </Grid>

  <div class="mt-8">
    <!-- Filter and Sort Controls -->
    <div class="flex flex-col sm:flex-row justify-between mb-6 gap-4">
      <div class="flex flex-wrap gap-2">
        <button class="filter-btn active" data-category="all">All</button>
        {
          categories.map((cat) => (
            <button class="filter-btn" data-category={cat}>
              {categoryLabels[cat] || cat}
            </button>
          ))
        }
      </div>
      <div>
        <button id="sort-toggle" class="sort-toggle">
          <svg 
            id="sort-icon" 
            width="16" 
            height="16" 
            viewBox="0 0 24 24" 
            fill="none" 
            stroke="currentColor" 
            stroke-width="2" 
            stroke-linecap="round" 
            stroke-linejoin="round"
            style="transition: transform 0.2s ease;"
          >
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
          <span id="sort-text">Newest First</span>
        </button>
      </div>
    </div>

    <div id="projects-container" class="grid md:grid-cols-2 gap-4">
      {
        sortedProjects.map((project) => (
          <a
            href={`/project/${project.slug}`}
            class="no-underline project-item group"
            data-category={project.data.category}
            data-year={project.data.year}
          >
            <GridItem className="h-full flex-col hover:border-primary-border transition-colors overflow-hidden">
              <!-- Thumbnail Placeholder -->
              <div class="placeholder-img -mx-4 -mt-4 mb-4">
                <span>Preview Placeholder</span>
              </div>
              
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <h3 class="text-lg font-semibold text-primary-text">
                    {project.data.title}
                  </h3>
                  <span class="badge">{categoryLabels[project.data.category]}</span>
                </div>
                <p class="text-tertiary-text text-sm mt-1">{project.data.year}</p>
                <p class="text-tertiary-text text-sm mt-2 line-clamp-2">
                  {project.data.description}
                </p>
                <div class="flex flex-wrap gap-2 mt-3">
                  {project.data.tags.slice(0, 4).map((tag) => (
                    <span class="badge">{tag}</span>
                  ))}
                  {project.data.tags.length > 4 && (
                    <span class="badge">+{project.data.tags.length - 4}</span>
                  )}
                </div>
              </div>
              
              <div class="mt-4 pt-4 border-t border-secondary-border flex items-center text-sm text-secondary-text group-hover:text-primary-text transition-colors">
                <span>View Details</span>
                <ArrowRightIcon size={14} customClasses="ml-2" />
              </div>
            </GridItem>
          </a>
        ))
      }
    </div>
  </div>
</Layout>
