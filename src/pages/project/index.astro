---
import { getCollection } from "astro:content";
import Grid from "@/components/bento/Grid.astro";
import GridItem from "@/components/bento/Item.astro";
import Header from "@/components/util/Header.astro";
import Layout from "@/layouts/Layout.astro";
import { ChevronDownIcon, ChevronUpIcon, ArrowRightIcon } from "astro-feather";

const projects = await getCollection("projects");
const sortedProjects = projects.sort((a, b) => b.data.year - a.data.year);

// Get unique categories
const categories = [...new Set(projects.map((p) => p.data.category))];
---

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const projectItems = document.querySelectorAll(".project-item");
    const filterButtons = document.querySelectorAll(".filter-btn");
    const sortToggle = document.getElementById("sort-toggle");
    const sortText = document.getElementById("sort-text");
    const sortIconContainer = document.getElementById("sort-icon-container");
    const projectsContainer = document.getElementById("projects-container");

    const urlParams = new URLSearchParams(window.location.search);
    let currentCategory = urlParams.get("category") || "all";
    let currentSort = urlParams.get("sort") || "newest";

    function updateSortIcon() {
      if (sortIconContainer) {
        const icons = sortIconContainer.querySelectorAll(".sort-icon");
        if (currentSort === "newest") {
          icons[0].classList.remove("hidden");
          icons[1].classList.add("hidden");
        } else {
          icons[0].classList.add("hidden");
          icons[1].classList.remove("hidden");
        }
      }
    }

    function filterProjects() {
      projectItems.forEach((item) => {
        const itemCategory = item.getAttribute("data-category");
        if (currentCategory === "all" || itemCategory === currentCategory) {
          (item as HTMLElement).style.display = "";
        } else {
          (item as HTMLElement).style.display = "none";
        }
      });
    }

    function sortProjects() {
      const items = Array.from(projectItems);
      items.sort((a, b) => {
        const yearA = parseInt(a.getAttribute("data-year") || "0");
        const yearB = parseInt(b.getAttribute("data-year") || "0");
        return currentSort === "newest" ? yearB - yearA : yearA - yearB;
      });

      items.forEach((item) => {
        projectsContainer?.appendChild(item);
      });
    }

    function updateURL() {
      const url = new URL(window.location.href);
      if (currentCategory === "all") {
        url.searchParams.delete("category");
      } else {
        url.searchParams.set("category", currentCategory);
      }
      if (currentSort === "newest") {
        url.searchParams.delete("sort");
      } else {
        url.searchParams.set("sort", currentSort);
      }
      window.history.pushState({}, "", url);
    }

    function applyFiltersAndSort() {
      filterProjects();
      sortProjects();
      updateSortIcon();
      updateURL();
    }

    function setInitialActiveState() {
      filterButtons.forEach((btn) => {
        const btnCategory = btn.getAttribute("data-category");
        if (btnCategory === currentCategory) {
          btn.classList.add("active");
        } else {
          btn.classList.remove("active");
        }
      });
      if (sortText) {
        sortText.textContent =
          currentSort === "newest" ? "Newest First" : "Oldest First";
      }
    }

    filterButtons.forEach((button) => {
      button.addEventListener("click", () => {
        filterButtons.forEach((btn) => btn.classList.remove("active"));
        button.classList.add("active");
        currentCategory = button.getAttribute("data-category") || "all";
        applyFiltersAndSort();
      });
    });

    sortToggle?.addEventListener("click", () => {
      currentSort = currentSort === "newest" ? "oldest" : "newest";
      if (sortText) {
        sortText.textContent =
          currentSort === "newest" ? "Newest First" : "Oldest First";
      }
      applyFiltersAndSort();
    });

    setInitialActiveState();
    applyFiltersAndSort();
  });
</script>

<style>
  .badge {
    @apply text-xs px-2 py-1 bg-secondary-bg text-secondary-text rounded;
  }
  .filter-btn {
    @apply px-3 py-1 rounded-md text-sm transition-colors;
  }
  .filter-btn.active {
    @apply bg-primary-accent text-white;
  }
  .filter-btn:not(.active) {
    @apply bg-secondary-bg text-secondary-text hover:bg-tertiary-bg;
  }
  .sort-toggle {
    @apply flex items-center gap-2 px-3 py-1 rounded-md text-sm bg-secondary-bg text-secondary-text hover:bg-tertiary-bg transition-colors;
  }
  .hidden {
    display: none;
  }
  .placeholder-img {
    @apply bg-secondary-bg border-2 border-dashed border-secondary-border rounded-lg flex items-center justify-center h-32 text-muted-text text-sm;
  }
</style>

<Layout title="Pak Maneth | Projects" desc="A collection of things I've built.">
  <Grid className="auto-rows-auto">
    <Header heading="Projects" subtitle="A collection of things I've built." />
  </Grid>

  <div class="mt-8">
    <!-- Filter and Sort Controls -->
    <div class="flex flex-col sm:flex-row justify-between mb-6 gap-4">
      <div class="flex flex-wrap gap-2">
        <button class="filter-btn active" data-category="all">All</button>
        {
          categories.map((cat) => (
            <button class="filter-btn" data-category={cat}>
              {cat}
            </button>
          ))
        }
      </div>
      <div>
        <button id="sort-toggle" class="sort-toggle">
          <span id="sort-icon-container">
            <ChevronDownIcon size={16} customClasses="sort-icon" />
            <ChevronUpIcon size={16} customClasses="sort-icon hidden" />
          </span>
          <span id="sort-text">Newest First</span>
        </button>
      </div>
    </div>

    <div id="projects-container" class="grid md:grid-cols-2 gap-4">
      {
        sortedProjects.map((project) => (
          <a
            href={`/project/${project.slug}`}
            class="no-underline project-item group"
            data-category={project.data.category}
            data-year={project.data.year}
          >
            <GridItem className="h-full flex-col hover:border-primary-border transition-colors overflow-hidden">
              <!-- Thumbnail Placeholder -->
              <div class="placeholder-img -mx-4 -mt-4 mb-4">
                <span>Preview Placeholder</span>
              </div>
              
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <h3 class="text-lg font-semibold text-primary-text">
                    {project.data.title}
                  </h3>
                  <span class="badge capitalize">{project.data.category}</span>
                </div>
                <p class="text-tertiary-text text-sm mt-1">{project.data.year}</p>
                <p class="text-tertiary-text text-sm mt-2 line-clamp-2">
                  {project.data.description}
                </p>
                <div class="flex flex-wrap gap-2 mt-3">
                  {project.data.tags.slice(0, 4).map((tag) => (
                    <span class="badge">{tag}</span>
                  ))}
                  {project.data.tags.length > 4 && (
                    <span class="badge">+{project.data.tags.length - 4}</span>
                  )}
                </div>
              </div>
              
              <div class="mt-4 pt-4 border-t border-secondary-border flex items-center text-sm text-secondary-text group-hover:text-primary-text transition-colors">
                <span>View Details</span>
                <ArrowRightIcon size={14} customClasses="ml-2" />
              </div>
            </GridItem>
          </a>
        ))
      }
    </div>
  </div>
</Layout>
