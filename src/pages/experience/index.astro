---
import { getCollection } from "astro:content";
import Grid from "@/components/bento/Grid.astro";
import GridItem from "@/components/bento/Item.astro";
import Header from "@/components/util/Header.astro";
import Layout from "@/layouts/Layout.astro";
import { CERTS, ACHIEVEMENTS, TALKS } from "@/constants";
import { Image } from "astro:assets";

const experiences = await getCollection("experiences");
const sortedExperiences = experiences.sort((a, b) => a.data.order - b.data.order);
const skills = await getCollection("skills");
const sortedSkills = skills.sort((a, b) => a.data.order - b.data.order);
---

<style>
  .timeline-item {
    @apply mb-6 relative pl-6 border-l-2 border-secondary-border;
  }
  .timeline-item::before {
    content: '';
    @apply absolute left-[-5px] top-1 w-2 h-2 rounded-full bg-primary-accent;
  }
  h3 {
    @apply text-base font-normal;
  }
  h4 {
    @apply text-sm text-tertiary-text font-normal font-sans;
  }
  time {
    @apply text-xs text-muted-text block mt-1;
  }
  .tech-tag {
    @apply text-xs px-2 py-0.5 bg-secondary-bg text-secondary-text rounded mt-2 inline-block mr-1;
  }
  .cert-item {
    @apply mb-4;
  }
  .achievement-item {
    @apply mb-4;
  }
</style>

<Layout
  title="Pak Maneth | Experience & Achievements"
  desc="A detailed overview of my professional journey, certifications, and achievements."
>
  <Grid className="auto-rows-auto">
    <Header
      heading="Professional Journey"
      subtitle="My work experience, technical skills, certifications, and notable achievements."
    />

    <!-- Technical Skills -->
    <GridItem className="p-6 flex-col">
      <section>
        <h2 class="text-xl font-semibold mb-4 font-serif">Technical Skills</h2>
        <div class="space-y-6">
          {
            [
              { level: "expert", label: "Expert" },
              { level: "advanced", label: "Advanced" },
              { level: "familiar", label: "Familiar" }
            ].map(({ level, label }) => {
              const skillsAtLevel = sortedSkills.filter((skill) => skill.data.proficiency === level);
              const items = skillsAtLevel.flatMap((skill) => skill.data.items);
              return (
                <div class="space-y-2">
                  <h3 class="text-sm font-medium text-secondary-text">{label}</h3>
                  <div class="flex flex-wrap gap-1.5">
                    {items.map((item) => (
                      <span class="tech-tag">{item}</span>
                    ))}
                  </div>
                </div>
              );
            })
          }
        </div>
      </section>
    </GridItem>

    <!-- Work Experience -->
    <GridItem className="p-6 flex-col">
      <section>
        <h2 class="text-xl font-semibold mb-4 font-serif">Work Experience</h2>
        {
          sortedExperiences.map((exp) => (
            <div class="timeline-item">
              <h3>{exp.data.role}</h3>
              <h4>
                {exp.data.companyUrl ? (
                  <a href={exp.data.companyUrl} target="_blank" class="underline">
                    {exp.data.company}
                  </a>
                ) : (
                  exp.data.company
                )}
                <span class="text-muted-text"> • {exp.data.location}</span>
              </h4>
              <time>
                {exp.data.startDate} - {exp.data.endDate}
              </time>
              
              <div class="mt-2 text-sm text-secondary-text">
                <p>{exp.body}</p>
                
                {exp.data.achievements && exp.data.achievements.length > 0 && (
                  <ul class="list-disc list-inside mt-2 space-y-1">
                    {exp.data.achievements.map((achievement) => (
                      <li>{achievement}</li>
                    ))}
                  </ul>
                )}
              </div>
              
              <div class="mt-2">
                {exp.data.technologies.map((tech) => (
                  <span class="tech-tag">{tech}</span>
                ))}
              </div>
            </div>
          ))
        }
      </section>

      <!-- Education -->
      <section class="mt-8">
        <h2 class="text-xl font-semibold mb-4 font-serif">Education</h2>
        <div class="timeline-item">
          <h3>Bachelor of Engineering in Software Engineering</h3>
          <h4>Kirirom Institute of Technology</h4>
          <time>2019 - 2023</time>
        </div>
      </section>
    </GridItem>

    <!-- Certifications -->
    <GridItem className="p-6 flex-col">
      <section>
        <h2 class="text-xl font-semibold mb-4 font-serif">Certifications</h2>
        {
          CERTS.map(({ name, url, issuedBy, issuedAt }) => (
            <div class="cert-item">
              <a href={url} target="_blank" class="block">
                <h3 class="text-base">{name}</h3>
              </a>
              <h4>{issuedBy}</h4>
              <time>{issuedAt}</time>
            </div>
          ))
        }
      </section>
    </GridItem>

    <!-- Achievements -->
    <GridItem className="p-6 flex-col">
      <section>
        <h2 class="text-xl font-semibold mb-4 font-serif">Achievements</h2>
        {
          ACHIEVEMENTS.map(({ name, organizedBy, issuedAt }) => (
            <div class="achievement-item">
              <h3 class="text-base">{name}</h3>
              <h4>{organizedBy}</h4>
              <time>{issuedAt}</time>
            </div>
          ))
        }
      </section>
    </GridItem>

    <!-- Talks -->
    <GridItem className="p-6 flex-col">
      <section>
        <h2 class="text-xl font-semibold mb-4 font-serif">Talks & Sharing</h2>
        {
          TALKS.sort((a, b) => b.date.localeCompare(a.date)).map(
            ({ title, event, location, date, description, slides, video, thumbnail }) => (
              <div class="timeline-item flex items-start gap-4 flex-col-reverse sm:flex-row">
                <div class="flex-1">
                  <h3>{title}</h3>
                  <h4>{event}</h4>
                  <p class="text-tertiary-text mb-1 italic">{location}</p>
                  <time>{date}</time>
                  <p class="mt-2 text-sm text-secondary-text">{description}</p>
                  <div class="flex gap-4 mt-3">
                    {slides && (
                      <a
                        href={slides}
                        target="_blank"
                        class="text-blue-600 hover:text-blue-800 text-sm"
                      >
                        View Slides →
                      </a>
                    )}
                    {video && (
                      <a
                        href={video}
                        target="_blank"
                        class="text-blue-600 hover:text-blue-800 text-sm"
                      >
                        Watch Video →
                      </a>
                    )}
                  </div>
                </div>
                {thumbnail && (
                  <Image
                    src={thumbnail}
                    alt={title}
                    width={120}
                    height={120}
                    class="aspect-auto rounded-md object-cover object-center"
                  />
                )}
              </div>
            )
          )
        }
      </section>
    </GridItem>
  </Grid>
</Layout>
