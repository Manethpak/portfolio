---
import { getCollection } from "astro:content";
import Grid from "@/components/bento/Grid.astro";
import GridItem from "@/components/bento/Item.astro";
import Header from "@/components/util/Header.astro";
import Layout from "@/layouts/Layout.astro";
import { Image } from "astro:assets";
import { ChevronDownIcon } from "astro-feather";

const experiences = await getCollection("experiences");
const sortedExperiences = experiences.sort(
  (a, b) => a.data.order - b.data.order,
);
const skills = await getCollection("skills");
const sortedSkills = skills.sort((a, b) => a.data.order - b.data.order);

const certs = await getCollection("certs");
const sortedCerts = certs.sort((a, b) => a.data.order - b.data.order);

const achievements = await getCollection("achievements");
const sortedAchievements = achievements.sort(
  (a, b) => a.data.order - b.data.order,
);

const talks = await getCollection("talks");
const sortedTalks = talks.sort((a, b) => a.data.order - b.data.order);
---

<style>
  .timeline-item {
    @apply mb-6 relative pl-6 border-l-2 border-secondary-border;
  }
  .timeline-item::before {
    content: "";
    @apply absolute left-[-5px] top-1 w-2 h-2 rounded-full bg-primary-accent;
  }
  .accordion-btn {
    @apply flex items-center gap-2 mt-2 text-sm text-tertiary-text hover:text-primary-text transition-colors cursor-pointer;
  }
  .accordion-content {
    @apply hidden mt-3 pl-0;
  }
  .accordion-content.open {
    @apply block;
  }
  .accordion-icon {
    @apply transition-transform duration-200;
  }
  .accordion-icon.open {
    @apply rotate-180;
  }
</style>

<script>
  document.querySelectorAll(".accordion-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const content = btn.nextElementSibling;
      const icon = btn.querySelector(".accordion-icon");

      if (content?.classList.contains("accordion-content")) {
        content.classList.toggle("open");
        icon?.classList.toggle("open");
      }
    });
  });
</script>

<Layout
  title="Pak Maneth | Experience & Achievements"
  desc="A detailed overview of my professional journey, certifications, and achievements."
>
  <Grid className="auto-rows-auto">
    <Header
      heading="Professional Journey"
      subtitle="My work experience, technical skills, certifications, and notable achievements."
    />

    <!-- Work Experience -->
    <GridItem className="p-6 flex-col">
      <section>
        <h2 class="text-xl font-semibold mb-4 font-serif">Work Experience</h2>
        {
          sortedExperiences.map((exp) => (
            <div class="timeline-item">
              <h3>{exp.data.role}</h3>
              <h4>
                {exp.data.companyUrl ? (
                  <a
                    href={exp.data.companyUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="underline"
                  >
                    {exp.data.company}
                  </a>
                ) : (
                  exp.data.company
                )}
                <span class="text-muted-text"> • {exp.data.location}</span>
              </h4>
              <time>
                {exp.data.startDate} - {exp.data.endDate}
              </time>

              <div class="mt-2 text-sm text-secondary-text">
                <p>{exp.data.summary}</p>
              </div>

              <button class="accordion-btn" type="button">
                <ChevronDownIcon customClasses="accordion-icon" size={16} />
                <span>View responsibilities</span>
              </button>

              <div class="accordion-content">
                <ul class="list-disc list-inside space-y-2 text-sm text-secondary-text">
                  {exp.data.responsibilities.map((resp) => (
                    <li>{resp}</li>
                  ))}
                </ul>
              </div>

              <div class="mt-2">
                {exp.data.technologies.map((tech) => (
                  <span class="tech-tag">{tech}</span>
                ))}
              </div>
            </div>
          ))
        }
      </section>

      <!-- Education -->
      <section class="mt-8">
        <h2 class="text-xl font-semibold mb-4 font-serif">Education</h2>
        <div class="timeline-item">
          <h3>Bachelor of Engineering in Software Engineering</h3>
          <h4>
            <a
              href="https://www.kit.edu.kh/"
              target="_blank"
              rel="noopener noreferrer"
            >
              Kirirom Institute of Technology
            </a>
          </h4>
          <time>2019 - 2023</time>
        </div>
      </section>
    </GridItem>

    <!-- Technical Skills -->
    <GridItem className="p-6 flex-col">
      <section>
        <h2 class="text-xl font-semibold mb-4 font-serif">Technical Skills</h2>
        <div class="space-y-6">
          {
            [
              { level: "expert", label: "Expert" },
              { level: "advanced", label: "Advanced" },
              { level: "familiar", label: "Familiar" },
            ].map(({ level, label }) => {
              const skillsAtLevel = sortedSkills.filter(
                (skill) => skill.data.proficiency === level,
              );
              const items = skillsAtLevel.flatMap((skill) => skill.data.items);
              return (
                <div class="space-y-2">
                  <h3 class="font-medium text-secondary-text">{label}</h3>
                  <div class="flex flex-wrap gap-1.5">
                    {items.map((item) => (
                      <span class="tech-tag">{item}</span>
                    ))}
                  </div>
                </div>
              );
            })
          }
        </div>
      </section>
    </GridItem>

    <!-- Certifications -->
    <GridItem className="p-6 flex-col">
      <section>
        <h2 class="text-xl font-semibold mb-4 font-serif">Certifications</h2>
        <div class="space-y-3">
          {
            sortedCerts.map(({ data: { name, url, issuedBy, issuedAt } }) => (
              <div>
                <h3 class="text-base">
                  <a href={url} target="_blank" rel="noopener noreferrer">
                    {name}
                  </a>
                </h3>
                <h4>{issuedBy}</h4>
                <time>{issuedAt}</time>
              </div>
            ))
          }
        </div>
      </section>
    </GridItem>

    <!-- Achievements -->
    <GridItem className="p-6 flex-col">
      <section>
        <h2 class="text-xl font-semibold mb-4 font-serif">Achievements</h2>
        <div class="space-y-3">
          {
            sortedAchievements.map(
              ({ data: { name, organizedBy, issuedAt } }) => (
                <div class="achievement-item">
                  <h3 class="text-base">{name}</h3>
                  <h4>{organizedBy}</h4>
                  <time>{issuedAt}</time>
                </div>
              ),
            )
          }
        </div>
      </section>
    </GridItem>

    <!-- Talks -->
    <GridItem className="p-6 flex-col">
      <section>
        <h2 class="text-xl font-semibold mb-4 font-serif">Talks & Sharing</h2>
        {
          sortedTalks
            .sort((a, b) => b.data.date.localeCompare(a.data.date))
            .map(
              ({
                data: {
                  title,
                  event,
                  location,
                  date,
                  description,
                  slides,
                  video,
                  thumbnail,
                },
              }) => (
                <div class="timeline-item flex items-start gap-4 flex-col-reverse sm:flex-row">
                  <div class="flex-1">
                    <h3>{title}</h3>
                    <h4>{event}</h4>
                    <p class="text-tertiary-text mb-1 italic">{location}</p>
                    <time>{date}</time>
                    <p class="mt-2 text-sm text-secondary-text">
                      {description}
                    </p>
                    <div class="flex gap-4 mt-3">
                      {slides && (
                        <a
                          href={slides}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="text-blue-600 hover:text-blue-800 text-sm"
                        >
                          View Slides →
                        </a>
                      )}
                      {video && (
                        <a
                          href={video}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="text-blue-600 hover:text-blue-800 text-sm"
                        >
                          Watch Video →
                        </a>
                      )}
                    </div>
                  </div>
                  {thumbnail && (
                    <Image
                      src={thumbnail}
                      alt={title}
                      width={120}
                      height={120}
                      class="aspect-auto rounded-md object-cover object-center"
                    />
                  )}
                </div>
              ),
            )
        }
      </section>
    </GridItem>
  </Grid>
</Layout>
